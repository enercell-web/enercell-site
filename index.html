<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>EnerCell</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #121212;
      background-image: url("/static/grid_background_soft.png");
      background-repeat: repeat;
      background-size: 50px 50px;
      height: 100vh;
      font-family: 'Roboto', sans-serif;
      position: relative;
    }

  #logo-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    opacity: 0.06;
    filter: brightness(1.3);
    z-index: 2;
    pointer-events: none;
  }

  #logo-overlay img {
    max-width: 40%;
    height: auto;
  }

  #main-graph-area {
    position: relative;
    width: 100%;
    height: 100%;
  }



    #container {
     width: 1920px;
     height: 991px;
     transform-origin: top left;
     position: absolute;
    }

  #chart {
    width: 93.96vw;
    height: 50.45vh;
    margin-left: 0.10vw;
    margin-top: 7.06vh;
    background: transparent;
    position: absolute;
    z-index: 5;
  }

   #histogram-custom {
    position: absolute;
    width: 78.13vw;
    height: 12.52vh;
    margin-left: 0.52vw;
    margin-top: 63.59vh;
    overflow: hidden;
    z-index: 1;
    background: transparent;
  }


  #profit-chart {
    position: absolute;
    top: 34.80vh;
    left: 0.26vw;
    width: 78.13vw;
    height: 20.14vh;
    z-index: 1;
    pointer-events: none;
  }


  #price-scale {
    position: absolute;
    top: 8.07vh;
    right: 1.04vw;
    width: 5.21vw;
    height: 80.71vh;
    background: transparent;
    font-family: 'Roboto', sans-serif;
    font-weight: 300;
    font-size: 1.67vw;
    color: #00f0ff;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: flex-start;
    pointer-events: none;
    z-index: 2;
    padding-left: 0.52vw;
  }


   #vertical-line {
    position: absolute;
    top: -5.05vh;
    left: -0.42vw;
    height: 90.81vh;
    width: 0.10vw;
    background-color: #00f0ff;
    z-index: 5;
  }


    /* Energy Price sz√∂vegdoboz */
  #price-display {
    position: absolute;
    top: 3.03vh;
    left: 80.21vw;
    background-color: transparent;
    padding: 1.51vh 1.3vw;
    border-radius: 8px;
    text-align: center;
    z-index: 5;
    display: block;
  }


  #price-label {
    font-family: 'Arial', sans-serif;
    font-size: 3.23vh;
    color: #00f0ff;
    margin-bottom: 1.01vh;
  }


  #price-value {
    font-family: 'Roboto', sans-serif;
    font-size: 3.83vh;
    color: #ffffff;
    margin-bottom: 0.5vh;
  }

  #price-unit {
    font-family: 'Roboto', sans-serif;
    font-size: 2.42vh;
    color: #ffffff;
  }
  #tooltip {
    position: absolute;
    top: 0.0vh;
    left: 0.0vw;
    background: rgba(0, 0, 0, 0.8);
    color: #ffffff;
    padding: 0.81vh 0.62vw;
    border-radius: 4px;
    font-family: 'Roboto', sans-serif;
    font-size: 1.61vh;
    pointer-events: none;
    z-index: 5;
    white-space: nowrap;
    transform: translate(-50%, -50%);
    display: none;
  }

    /* --- P√ñC√ñK szab√°ly hozz√°adva --- */
   #price-scale div:not(#vertical-line)::before {
    content: "";
    display: inline-block;
    width: 0.78vw;
    height: 0.2vh;
    background-color: #26a69a;
    margin-right: 0.1vw;
    position: relative;
    top: -0.81vh;
    left: -0.94vw;
  }

       /* profit sz√∂vegdobozok alapbe√°ll√≠t√°sa */
  #profit-display, #total-profit-display {
    position: absolute;
    background-color: transparent;
    padding: 1.51vh 1.04vw;
    border-radius: 8px;
    text-align: center;
    z-index: 5;
    display: block;
  }

    /* K√ºl√∂n poz√≠ci√≥k */
  #profit-display {
    top: 45.41vh;
    left: 81.29vw;
  }

  #total-profit-display {
    top: 74.18vh;
    left: 77.35vw;
  }

    /* Feliratok (label-ek) */
  #profit-label {
    font-family: 'Arial', sans-serif;
    font-size: 2.83vh;
    color: #00f0ff;
    margin-bottom: 1.01vh;
  }


  #total-profit-label {
    font-family: 'Arial', sans-serif;
    font-size: 3.53vh;
    color: #00f0ff;
    margin-bottom: 1.01vh;
  }



    /* √ârt√©kek (value-k) */
  #profit-value, #total-profit-value {
    font-family: 'Roboto', sans-serif;
    font-size: 3.63vh;
    color: #ffffff;
    margin-bottom: 0.5vh;
  }


    /* M√©rt√©kegys√©gek (unit-ok) */
  #profit-unit {
    font-family: 'Roboto', sans-serif;
    font-size: 4.04vh;
    color: #1fc8db;
  }

  #total-profit-unit {
    font-family: 'Roboto', sans-serif;
    font-size: 2.32vh;
    color: #1fc8db;
  }

  #tooltip {
  position: absolute;
  background: rgba(0, 0, 0, 0.5);  /* √°ttetsz≈ë fekete */
  color: #ffffff;
  padding: 0.5vh 1vw;
  border-radius: 5px;
  font-size: 1.4vh;
  pointer-events: none;
  z-index: 10;
  white-space: nowrap;
  transform: translate(-50%, -50%);
  display: none;
  }

  #stored-value-display {
    position: absolute;
    bottom: 2vh;
    left: 50%;
    transform: translateX(-50%);
    font-family: 'Roboto', sans-serif;
    font-size: 2.5vh;
    color: #00f0ff;
    background-color: rgba(18, 18, 18, 0.8);
    padding: 0.5vh 1vw;
    border-radius: 8px;
    z-index: 9;
  }
  #histogram-tooltip {
    position: absolute;
    background-color: rgba(0, 0, 0, 0.6);
    color: #fff;
    padding: 6px 12px;
    border-radius: 5px;
    font-size: 14px;
    pointer-events: none;
    z-index: 100;
    display: none;
  }

  #histogram-custom {
    position: absolute;
    width: 75.13vw;
    height: 22.52vh;
    margin-left: 0.52vw;
    margin-top: 70.59vh;
    overflow: hidden;
    z-index: 10;
    background: transparent;
  }

  #bars-container {
    position: absolute;
    bottom: 0;
    width: 100%;
    display: flex;
    align-items: flex-end;
    height: auto; /* ez fontos */
  }

  .bar {
    width: 1.1vw;
    margin-right: 0.1vw;
    border-radius: 3px;
    background-color: rgba(0, 240, 255, 0.5);
    transition: height 0.2s ease, background-color 0.2s ease;
  }

  #background-energy-value {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 0;
    pointer-events: none;
    text-align: center;
    white-space: nowrap;
  }

  .energy-number {
    font-size: 18vw;
    font-weight: 900;
    color: rgba(255, 255, 255, 0.15); /* er≈ësebb, de m√©g szellem */
  }

  .energy-unit {
    font-size: 5vw;
    font-weight: 400;
    margin-left: 1vw;
    color: rgba(255, 255, 255, 0.40); /* halv√°nyabb, kisebb */
  }

  .energy-sub {
    font-size: 4vw;
    color: rgba(255, 255, 255, 0.15); /* legszellemibb */
    letter-spacing: 0.3vw;
    margin-top: 0vw;
  }

  #background-energy-value {
    position: absolute;
    top: 53.5%;
    left: 41%;
    transform: translate(-50%, -50%);
    z-index: 0;
    pointer-events: none;
    text-align: center;
    white-space: nowrap;

    /* maszkol√°s: bal oldal er≈ës, jobb oldal elhalv√°nyul */
    -webkit-mask-image: linear-gradient(to right, rgba(0, 0, 0, 1) 30%, rgba(0, 0, 0, 0.2) 100%);
    mask-image: linear-gradient(to right, rgba(0, 0, 0, 1) 30%, rgba(0, 0, 0, 0.2) 100%);
    mask-size: 100%;
    mask-repeat: no-repeat;
  }




  </style>

  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

</head>
<body>

<div id="main-graph-area">
  <div id="logo-overlay">
    <img src="logo.png" alt="EnerCell logo" />
  </div>


<div id="background-energy-value">
  <div class="energy-sub">automated</div>
  <span class="energy-number">197.4</span>
  <span class="energy-unit">MWh</span>
</div>





<div id="container">
  <div id="chart"></div>
  <div id="profit-chart"></div>

  <!-- Histogram -->
  <div id="histogram-custom">
    <div id="bars-container"></div>
  </div>

  <!-- √År-sk√°la -->
  <div id="price-scale">
    <div id="vertical-line"></div>
  </div>

  <!-- Aktu√°lis √°r -->
  <div id="price-display">
    <div id="price-label">Energy Price</div>
    <div id="price-value">--.--</div>
    <div id="price-unit">Euro/MWh</div>
  </div>

  <!-- Aktu√°lis profit % -->
  <div id="profit-display">
    <div id="profit-label">Current Profit:</div>
    <div>
      <span id="profit-value">--.--</span><span id="profit-unit"> %</span>
    </div>
  </div>

  <!-- √ñsszes√≠tett profit EUR -->
  <div id="total-profit-display">
    <div id="total-profit-label">Total Revenue:</div>
    <div id="total-profit-value">1.000.000.195</div>
    <div id="total-profit-unit">EUR</div>
  </div>

  <!-- Tooltip elemek -->
  <div id="histogram-tooltip"></div>
  <div id="stored-value-display"></div>
  <div id="tooltip" style="position:absolute; display:none;"></div>
</div>


<script>
  function scaleToFit() {
  const baseWidth = 1920;
  const baseHeight = 991;
  const currentWidth = window.innerWidth;
  const currentHeight = window.innerHeight;

  const baseRatio = baseWidth / baseHeight;
  const currentRatio = currentWidth / currentHeight;

  const container = document.getElementById('container');

  // Ha a k√©par√°ny k√∂zel azonos (¬±1%), ar√°nyosan sk√°l√°z
  if (Math.abs(baseRatio - currentRatio) < 0.01) {
    const scaleX = currentWidth / baseWidth;
    const scaleY = currentHeight / baseHeight;
    const scale = Math.min(scaleX, scaleY);
    container.style.transform = `scale(${scale})`;
  } else {
    // Ha m√°s az ar√°ny, torz√≠tva fesz√≠t r√°
    const scaleX = currentWidth / baseWidth;
    const scaleY = currentHeight / baseHeight;
    container.style.transform = `scale(${scaleX}, ${scaleY})`;
  }
}

</script>



<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

<script>
console.log('Aktu√°lis sz√©less√©g:', window.innerWidth);
console.log('Aktu√°lis magass√°g:', window.innerHeight);
let formattedHistogramData = [];




const candlestickChart = LightweightCharts.createChart(document.getElementById('chart'), {
  layout: {
    background: { color: 'transparent' }, //#121212
    textColor: 'transparent', //#26a69a
    fontSize: 22,                  // üîπ Ez n√∂veli a sk√°l√°k √©s a doboz bet≈±m√©ret√©t
    fontFamily: 'Roboto',
  },
  grid: {
    vertLines: { color: 'transparent' },
    horzLines: { color: 'transparent' },
  },
  leftPriceScale: {
    borderColor: '#121212',
    fontSize: 18,                  // üîπ Ez n√∂veli a sk√°l√°k √©s a doboz bet≈±m√©ret√©t
    visible: true,
    alignLabels: true,         // üîπ EZ szor√≠tja ki balra a c√≠mk√©ket
    scaleMargins: {
      top: 0,
      bottom: 0,
    }
  },
  layout: {
  background: { color: 'transparent' },
  textColor: '#00f0ff',
  fontFamily: 'Roboto',
  },
  timeScale: {
    borderColor: '#121212',
    visible: false,
    rightOffset: 0,
    rightOffset: 19,      // üî• jobb oldalon helyet hagy
    fixLeftEdge: false,   // üî• bal oldalon is hagy helyet
    barSpacing: 10,
  },
  crosshair: {
    mode: LightweightCharts.CrosshairMode.Normal,
  },
  handleScroll: {
    mouseWheel: true,
    pressedMouseMove: true,
  },
  handleScale: {
    axisPressedMouseMove: true,
    mouseWheel: true,
    pinch: true,
  }
});

const candleSeries = candlestickChart.addCandlestickSeries({
  priceScaleId: 'left',
  upColor: '#00f0ff',
  downColor: '#ef5350',
  borderUpColor: '#26a69a',
  borderDownColor: '#ef5350',
  wickUpColor: '#00f0ff',
  wickDownColor: '#ef5350',
});

const profitChart = LightweightCharts.createChart(document.getElementById('profit-chart'), {
  layout: {
    background: { color: 'transparent' },
    textColor: '#ffffff',
    fontFamily: 'Roboto',
  },
  width: 1780,
  height: 400,
  grid: {
    vertLines: { color: 'rgba(255,255,255,0.0)' },
    horzLines: { color: 'rgba(255,255,255,0.0)' },
  },
  crosshair: {
    mode: LightweightCharts.CrosshairMode.Normal,
    horzLine: { visible: false },
    vertLine: { visible: false },
  },
  rightPriceScale: {
    visible: false,
    borderColor: 'rgba(255,255,255,0.07)',
    scaleMargins: { top: 0.1, bottom: 0.1 },
  },
  timeScale: {
    visible: false,
    borderColor: 'rgba(255,255,255,0.07)',
    timeVisible: false,
    fixLeftEdge: false,
    rightOffset: 5,
    barSpacing: 20,
  },
  localization: { locale: 'en-US' },
  handleScroll: {
    mouseWheel: true,
    pressedMouseMove: true,
  },
  handleScale: {
    axisPressedMouseMove: true,
    mouseWheel: true,
    pinch: true,
  }
});



// üîµ √öJ: k√ºl√∂n histogram chart az oszlopoknak

const histogramTooltip = document.getElementById('histogram-tooltip');

    if (!histogramTooltip) {
      console.error("üö® Nincs 'histogram-tooltip' elem a DOM-ban!");
    }



const profitSeries = profitChart.addLineSeries({
  color: 'rgba(255, 255, 255, 1.0)',  // kicsit √°ttetsz≈ë feh√©r
  lineWidth: 2.5,
  priceLineVisible: false       // ‚õî EZ TILTAJA LE a kis v√≠zszintes vonalat
});



let lastClose = 100;

async function fetchData() {
  console.log("üîÑ fetchData indul:", new Date().toLocaleTimeString());
  let json = null;

  try {
  const response = await fetch("/api/data");
  if (!response.ok) throw new Error("Helyi API nem v√°laszol");
  json = await response.json();
  } catch (error) {
    console.warn("Helyi API sikertelen, pr√≥b√°lkoz√°s k√ºls≈ë API-val...");
    try {
      const fallbackResponse = await fetch("https://api.enercell.pro/api/data");
      if (!fallbackResponse.ok) throw new Error("K√ºls≈ë API sem v√°laszol");
      json = await fallbackResponse.json();
    } catch (finalErr) {
      console.error("Nem siker√ºlt adatot lek√©rni semelyik forr√°sb√≥l.");
      return;
    }
  }


  if (!json) {
    console.error("json √ºres vagy null ‚Äì a fetch nem adott vissza adatot");
    return;
  }

    if (json.chart_candlestick && Array.isArray(json.chart_candlestick)) {
      const formattedData = json.chart_candlestick.map(item => ({
        time: item.x,
        open: item.o,
        high: item.h,
        low: item.l,
        close: item.c
      }));

      candleSeries.setData(formattedData);

      if (formattedData.length > 0) {
        lastClose = formattedData[formattedData.length - 1].close;
      }

      updatePriceScale();
    } else {
      console.error('Hib√°s adatstrukt√∫ra:', json);
    }

    if (json.chart_storage && Array.isArray(json.chart_storage)) {
      renderCustomHistogram(json.chart_storage);
      updateBackgroundEnergyDisplay(json.chart_storage); // üî• hozz√°adva
    }



/*
 if (json.chart_storage && Array.isArray(json.chart_storage)) {
  const windowSize = 12; // 6 √≥r√°s mozg√≥ ablak
  const rawData = json.chart_storage;

  formattedHistogramData = rawData.map((item, index) => {
    const from = Math.max(0, index - windowSize + 1);
    const slice = rawData.slice(from, index + 1);
    const values = slice.map(d => d.value);
    const localMin = Math.min(...values);
    const localMax = Math.max(...values);

    // Stabiliz√°lt tartom√°ny: legal√°bb 10 legyen a range
    const rawRange = localMax - localMin;
    const range = Math.max(rawRange, 10);

    const normalizedValue = (item.value - localMin) / range;

    // N√∂veked√©s/cs√∂kken√©s sz√≠n + √°ttetsz≈ës√©g
    const prev = rawData[index - 1]?.value ?? item.value;
    const diff = item.value - prev;

    const opacity = 0.3 + Math.min(Math.abs(diff) / 10, 0.7);
    const baseColor = diff >= 0
      ? `rgba(0, 240, 255, ${opacity.toFixed(2)})`   // n√∂veked√©s ‚Äì k√©k
      : `rgba(255, 100, 100, ${opacity.toFixed(2)})`; // cs√∂kken√©s ‚Äì piros

    return {
      time: item.time,
      value: normalizedValue,
      originalValue: item.value,
      color: baseColor
    };
  });

  // histogramSeries.setData(formattedHistogramData);
}
*/


    if (json.chart_profit && Array.isArray(json.chart_profit)) {
      const maxSteps = 84;        // 9 √≥r√°nyi adat
      const minOpacity = 0.05;    // legalacsonyabb √°ttetsz≈ës√©g
      const latestIndex = json.chart_profit.length - 1;

      const formattedProfitData = json.chart_profit.map((item, index) => {
        const distance = latestIndex - index;
        const fadeFactor = Math.min(distance / maxSteps, 1);
        const opacity = 1 - fadeFactor * (1 - minOpacity);

        return {
          time: item.time,
          value: item.value,
          color: `rgba(255, 255, 255, ${opacity.toFixed(3)})`
        };
      });

      profitSeries.setData(formattedProfitData);
    }



    // üî• Sz√∂veges adatok friss√≠t√©se
    if (json.energy_price !== undefined) {
      document.getElementById('price-value').textContent = json.energy_price.toFixed(2).replace('.', ',');
    }

    // üî• D√°tum adatok friss√≠t√©se
    if (json.current_datetime !== undefined) {
      window.lastDatetimeString = json.current_datetime;
    }

    if (json.current_profit !== undefined) {
    document.getElementById('profit-value').textContent = json.current_profit.toFixed(2).replace('.', ',');
    }

    if (json.total_cash !== undefined) {
      document.getElementById('total-profit-value').textContent = json.total_cash.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }


}
//
function updateBackgroundEnergyDisplay(data) {
  if (!Array.isArray(data) || data.length === 0) return;

  const latest = data[data.length - 1];
  const total = typeof latest.value === "number" ? latest.value : 0;

  const display = document.querySelector(".energy-number");
  if (display) {
    display.textContent = total.toFixed(1);
  }
}




//
function updatePriceScale() {
  const scale = document.getElementById('price-scale');
  if (!scale) return;

  const allDivs = scale.querySelectorAll('div');
  allDivs.forEach(div => {
    if (div.id !== 'vertical-line') {
      div.remove();
    }
  });
    // üîµ Lek√©rj√ºk az aktu√°lis d√°tumot a JSON alapj√°n
  const currentDateText = window.lastDatetimeString || "2024.01.01 00:00"; // fallback

  const [year, month, day] = currentDateText.split(' ')[0].split('.').map(s => parseInt(s, 10));
  const baseDate = new Date(year, month - 1, day);

  // üîµ Kisz√°m√≠tjuk a 4 el≈ëz≈ë √©s 4 k√∂vetkez≈ë napot
  const dates = [];
  for (let offset = 4; offset >= -4; offset--) {
    const d = new Date(baseDate);
    d.setDate(d.getDate() + offset);
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    dates.push(`${mm}.${dd}`);
  }

  // üîµ Megjelen√≠tj√ºk ≈ëket a sk√°l√°n
   for (let i = 0; i < dates.length; i++) {
    const label = dates[i];
    const distance = Math.abs(i - 4); // 4 a k√∂z√©ps≈ë, az aktu√°lis nap
    const opacity = 1 - distance * 0.15;  // min√©l messzebb, ann√°l √°ttetsz≈ëbb
    const scaleFactor = 1 - distance * 0.1; // min√©l messzebb, ann√°l kisebb

    const div = document.createElement('div');
    div.textContent = label;

    div.style.opacity = opacity.toFixed(2);
    div.style.transform = `scale(${scaleFactor.toFixed(2)})`;
    div.style.transformOrigin = 'center center';
    div.style.transition = 'all 0.3s ease';

    scale.appendChild(div);
  }






/*
  const rangePercent = 0.05;
  const min = lastClose * (1 - rangePercent);
  const max = lastClose * (1 + rangePercent);

  const step = (max - min) / 9;

  for (let i = 0; i <= 9; i++) {
    const value = (max - i * step).toFixed(2);
    const div = document.createElement('div');
    div.textContent = value;
    scale.appendChild(div);
  }
  */
}

const tooltip = document.getElementById('tooltip');

candlestickChart.subscribeCrosshairMove(function(param) {
  if (!param || !param.time || !param.seriesPrices) {
    tooltip.style.display = 'none';
    return;
  }

  const price = param.seriesPrices.get(candleSeries);
  const time = param.time;

  if (price === undefined) {
    tooltip.style.display = 'none';
    return;
  }

  updatePriceDisplay(price);

  tooltip.style.display = 'block';
  tooltip.innerHTML = `√År: ${price.toFixed(2)}<br>Id≈ë: ${formatTime(time)}`;
});

function formatTime(time) {
  const date = new Date(time * 1000);
  const year = date.getFullYear();
  const month = (date.getMonth() + 1).toString().padStart(2, '0');
  const day = date.getDate().toString().padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function updatePriceDisplay(price) {
  const priceValue = document.getElementById('price-value');
  if (price === undefined) {
    priceValue.textContent = "--.--";
  } else {
    priceValue.textContent = price.toFixed(2).replace('.', ',');
  }
}

function renderCustomHistogram(data) {
  const container = document.getElementById("bars-container");
  if (!container) return;
  container.innerHTML = "";

  const scaleFactor = 25;
  const last65 = data.slice(-65); // id≈ërend: r√©gi ‚Üí √∫j

  let maxValue = 0;

  for (let i = 0; i < last65.length; i++) {
    const current = last65[i];
    if (!current || typeof current.value !== "number") continue;

    maxValue = Math.max(maxValue, current.value);

    const bar = document.createElement("div");
    bar.className = "bar";
    bar.style.height = `${current.value * scaleFactor}px`;
    const alpha = 0.2 + (i / last65.length) * 0.6;
    bar.style.backgroundColor = `rgba(0, 240, 255, ${alpha})`;

    bar.title = `${current.value.toFixed(2)} MWh`;
    bar.style.marginRight = "3.7px"; // vagy ah√°ny px t√°vols√°got szeretn√©l
    container.appendChild(bar);
  }

  // semmi containerHeight, semmi flex, semmi alignItems
  // csak ha t√©nyleg sz√ºks√©ges, akkor maszkolunk (ez opcion√°lis):
  const maskHeight = document.getElementById("histogram-custom").offsetHeight;
  const shiftY = container.offsetHeight - maskHeight;
  container.style.transform = `translateY(${shiftY}px)`;
}



setTimeout(fetchData, 1000);        // 1 mp k√©s√©ssel elind√≠tjuk az els≈ë lek√©r√©st
setInterval(fetchData, 10000);      // minden 10 mp-ben pontosan fut

</script>



</html>
